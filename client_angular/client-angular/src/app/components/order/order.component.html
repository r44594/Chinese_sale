
<div class="admin-panel" dir="rtl">
<p-confirmDialog [style]="{width: '30vw'}"></p-confirmDialog>
  <header class="header-section">
    <h1 class="title">לוח ניהול רכישות</h1>

    <div class="nav-actions">
      <button pButton label="ניהול מכירות"
              (click)="loadMostPurchased()"
              [class.active]="currentView === 'popular'">
      </button>

      <button pButton label="פרטי רוכשים"
              (click)="loadAllBuyers()"
              [class.active]="currentView === 'buyers'">
      </button>

    <button pButton label="דוח זוכים והכנסות"
        icon="pi pi-chart-bar"
        class="p-button-secondary p-button-outlined" (click)="loadWinnersReport()">
</button>

<button *ngIf="currentView === 'popular'" 
        pButton label="בצע הגרלה לכל המוצרים" 
        icon="pi pi-star" 
        class="p-button-dark" (click)="random()">
</button>
    </div>
  </header>

  <div class="toolbar" *ngIf="currentView === 'popular'">
    <span>מיין לפי:</span>
    <button pButton label="מחיר" (click)="sortGifts('price')"></button>
    <button pButton label="כמות רכישות" (click)="sortGifts('purchased')"></button>
  </div>

  <div *ngIf="isLoading" class="loading-shade">
    <p-progressSpinner></p-progressSpinner>
    <p>טוען נתונים...</p>
  </div>

  <p-table *ngIf="currentView === 'popular' && !isLoading"
           [value]="filteredGifts"
           styleClass="p-datatable-striped shadow-2">

    <ng-template pTemplate="header">
      <tr>
        <th>שם מתנה</th>
        <th>מחיר כרטיס</th>
        <th>נמכרו</th>
        <th>סה״כ</th>
        <th>סטטוס</th>
        <th>צפיה בפרטי רוכשי מתנה זו</th>
      </tr>
    </ng-template>

    <ng-template pTemplate="body" let-gift>
      <tr>
        <td>{{ gift.giftName }}</td>
        <td>{{ gift.ticketPrice }} ₪</td>
        <td>{{ gift.totalQuantity }} כרטיסים</td>
        <td>{{ gift.ticketPrice * gift.totalQuantity }} ₪</td>
        <td>
          <p-tag [severity]="gift.isDrawn ? 'success' : 'warning'" 
                 [value]="gift.isDrawn ? 'הוגרל' : 'ממתין'">
          </p-tag>
        </td>
        <td>
          <div class="flex gap-2">
            <button pButton icon="pi pi-search" 
                    class="p-button-rounded p-button-text"
                    pTooltip="צפה ברוכשים"
                    (click)="openSpecificGiftBuyers(gift.giftId)">
            </button>
          </div>
        </td>
      </tr>
    </ng-template>
  </p-table>

  <p-table *ngIf="currentView === 'buyers' && !isLoading" [value]="buyers">
    <ng-template pTemplate="header">
      <tr>
        <th>שם מלא</th>
        <th>טלפון</th>
        <th>אימייל</th>
        <th>מתנה</th>
        <th>תאריך</th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-buyer>
      <tr>
        <td>{{ buyer.firstName }} {{ buyer.lastName }}</td>
        <td>{{ buyer.phone }}</td>
        <td>{{ buyer.email }}</td>
        <td>{{ buyer.giftName }}</td>
        <td>{{ buyer.orderDate | date:'dd/MM/yyyy HH:mm' }}</td>
      </tr>
    </ng-template>
  </p-table>

  <div *ngIf="currentView === 'winners' && !isLoading">
    <p-table [value]="winners" styleClass="p-datatable-gridlines">
      <ng-template pTemplate="header">
        <tr>
          <th>שם הזוכה</th>
          <th>מתנה שזכה בה</th>
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-winner>
        <tr>
          <td><i class="pi pi-user mr-2"></i> {{ winner.winnerName }}</td>
          <td><i class="pi pi-gift mr-2"></i> {{ winner.giftName }}</td>
        </tr>
      </ng-template>
    </p-table>

 <div class="income-summary shadow-4 mt-4 p-4 border-round">
  <h3 class="m-0 flex align-items-center gap-3">
    <i class="pi pi-wallet" style="font-size: 1.5rem;"></i>
    <span>סה"כ הכנסות מהמכירה:</span>
    <span class="text-2xl font-bold">{{ totalIncome | currency:'ILS':'symbol':'1.2-2' }}</span>
  </h3>
</div>
  </div>

</div>

<p-dialog header="רוכשי המתנה" [(visible)]="displayBuyersDialog" [modal]="true" [style]="{ width: '50vw' }">
  <p-table [value]="specificBuyers">
    <ng-template pTemplate="header">
      <tr>
        <th>שם</th>
        <th>טלפון</th>
        <th>תאריך</th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-buyer>
      <tr>
        <td>{{ buyer.firstName }} {{ buyer.lastName }}</td>
        <td>{{ buyer.phone }}</td>
        <td>{{ buyer.orderDate | date:'dd/MM' }}</td>
      </tr>
    </ng-template>
  </p-table>
</p-dialog>
